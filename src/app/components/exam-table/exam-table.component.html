<h2>Calendrier d'examen</h2>
<div *ngIf="!stepperVisible" class="text-center mt-3">
  <!-- Dropdown Section -->
  <div class="dropdowns row justify-content-center mb-4">
    <div class="col-6 col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Année universitaire</mat-label>
        <mat-select
          [(ngModel)]="selectedYear"
          (selectionChange)="onSelectionChange()"
        >
          <mat-option *ngFor="let year of academicYears" [value]="year">{{
            year
          }}</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <div class="col-6 col-md-3">
      <mat-form-field appearance="outline" class="w-100">
        <mat-label>Semestre</mat-label>
        <mat-select
          [(ngModel)]="selectedSemester"
          (selectionChange)="onSelectionChange()"
        >
          <mat-option *ngFor="let semester of semesters" [value]="semester">
            {{ semester }}
          </mat-option>
        </mat-select>
      </mat-form-field>
    </div>
  </div>
  <div class="text-center mt-3">
    <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
      <ng-container matColumnDef="prof">
        <th mat-header-cell *matHeaderCellDef>Professeur</th>
        <td mat-cell *matCellDef="let element">{{ element.professorName }}</td>
      </ng-container>

      <ng-container matColumnDef="program">
        <th mat-header-cell *matHeaderCellDef>Filière</th>
        <td mat-cell *matCellDef="let element">{{ element.programName }}</td>
      </ng-container>

      <ng-container matColumnDef="module">
        <th mat-header-cell *matHeaderCellDef>Module</th>
        <td mat-cell *matCellDef="let element">{{ element.moduleName }}</td>
      </ng-container>

      <ng-container matColumnDef="horaire">
        <th mat-header-cell *matHeaderCellDef>Horaire</th>
        <td mat-cell *matCellDef="let element">
          {{ element.examPeriodDebut }} à {{ element.examPeriodFin }}
        </td>
      </ng-container>

      <ng-container matColumnDef="classe">
        <th mat-header-cell *matHeaderCellDef>Classe</th>
        <td mat-cell *matCellDef="let element">{{ element.className }}</td>
      </ng-container>

      <ng-container matColumnDef="day">
        <th mat-header-cell *matHeaderCellDef>Jour</th>
        <td mat-cell *matCellDef="let element">{{ element.day }}</td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
  </div>
  <!-- Fallback for No Data -->
  <div
    *ngIf="!loadingSessions && dataSource.length === 0"
    class="alert alert-info text-center my-5"
  >
    <p class="mb-0">
      Veuillez sélectionner un semestre et une année universitaire.
    </p>
  </div>
  <!-- Action Buttons -->
  <div class="d-flex justify-content-center gap-3 mt-5">
    <button
      mat-raised-button
      style="background-color: #084981; color: white"
      (click)="stepperVisible = true"
    >
      <mat-icon>add</mat-icon>
      Créer un calendrier d'exam
    </button>
    <button mat-raised-button
    style="background-color: #084981; color: white;"
      (click)="deleteTable()"
    >
      <mat-icon>delete</mat-icon>
      Supprimer
    </button>
    <button mat-raised-button
    style="background-color: #084981; color: white;"
      (click)="updateTable()"
    >
      <mat-icon>edit</mat-icon>
      Mettre à jour
    </button>
  </div>
</div>

<div>
  <mat-stepper linear *ngIf="stepperVisible" #stepper class="scrollable-stepper">
    <mat-step [stepControl]="firstFormGroup">
      <form [formGroup]="firstFormGroup" (ngSubmit)="onYearSubmit()">
        <ng-template matStepLabel
          >Information de Calendrier des Examens</ng-template
        >
        <div class="text-center mt-3">
          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Année universitaire</mat-label>
            <input
              matInput
              placeholder="Année Universitaire"
              formControlName="year"
              required
            /> </mat-form-field
          ><br />
          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Semestre</mat-label>
            <input
              matInput
              placeholder="Semestre"
              formControlName="semester"
              required
            />
          </mat-form-field>
        </div>
        <div class="text-center mt-3">
          <button mat-raised-button color="primary" matStepperNext>
            Continuer
          </button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="secondFormGroup">
      <ng-template matStepLabel>Calendrier des Examens</ng-template>
      <div class="text-center mt-3">
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
          <ng-container matColumnDef="prof">
            <th mat-header-cell *matHeaderCellDef>Professeur</th>
            <td mat-cell *matCellDef="let element">
              {{ element.professorName }}
            </td>
          </ng-container>

          <ng-container matColumnDef="program">
            <th mat-header-cell *matHeaderCellDef>Filière</th>
            <td mat-cell *matCellDef="let element">
              {{ element.programName }}
            </td>
          </ng-container>

          <ng-container matColumnDef="module">
            <th mat-header-cell *matHeaderCellDef>Module</th>
            <td mat-cell *matCellDef="let element">{{ element.moduleName }}</td>
          </ng-container>

          <ng-container matColumnDef="horaire">
            <th mat-header-cell *matHeaderCellDef>Horaire</th>
            <td mat-cell *matCellDef="let element">
              {{ element.examPeriodDebut }} à {{ element.examPeriodFin }}
            </td>
          </ng-container>

          <ng-container matColumnDef="classe">
            <th mat-header-cell *matHeaderCellDef>Classe</th>
            <td mat-cell *matCellDef="let element">{{ element.className }}</td>
          </ng-container>

          <ng-container matColumnDef="day">
            <th mat-header-cell *matHeaderCellDef>Jour</th>
            <td mat-cell *matCellDef="let element">{{ element.day }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
        </table>
      </div>

      <form [formGroup]="secondFormGroup">
        <div class="text-center mt-3">
          <button mat-raised-button class="m-2" matStepperPrevious>
            Retour
          </button>
          <button mat-raised-button color="primary" matStepperNext>
            Continuer
          </button>
        </div>
      </form>
    </mat-step>

    <mat-step [stepControl]="thirdFormGroup">
      <form [formGroup]="thirdFormGroup" (ngSubmit)="addSessionExamRow()">
        <ng-template matStepLabel>Ajouter une ligne</ng-template>
        <div class="text-center mt-3">
          <div *ngIf="errorMessage" class="error-message">
            {{ errorMessage }}
          </div>
          <br />
          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Filière</mat-label>
            <mat-select formControlName="prog" required>
              <mat-option>--</mat-option>
              <mat-option *ngFor="let program of programs" [value]="program.id">
                {{ program.programName }}
              </mat-option>
            </mat-select> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Professeur</mat-label>
            <mat-select formControlName="prof" required>
              <mat-option>--</mat-option>
              <mat-option *ngFor="let person of persons" [value]="person.id">
                {{ person.name }}
              </mat-option>
            </mat-select> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Module</mat-label>
            <mat-select formControlName="module" required>
              <mat-option>--</mat-option>
              <mat-option *ngFor="let module of modules" [value]="module.id">
                {{ module.moduleName }}
              </mat-option>
            </mat-select> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Jour</mat-label>
            <input
              matInput
              [matDatepicker]="jour"
              formControlName="day"
              required
            />
            <mat-hint>MM/DD/YYYY</mat-hint>
            <mat-datepicker-toggle matIconSuffix [for]="jour">
              <mat-icon matDatepickerToggleIcon>keyboard_arrow_down</mat-icon>
            </mat-datepicker-toggle>
            <mat-datepicker #jour></mat-datepicker> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Heure de début</mat-label>
            <input
              matInput
              type="time"
              formControlName="heureDebut"
            /> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Heure de fin</mat-label>
            <input
              matInput
              type="time"
              formControlName="heureFin"
            /> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Capacité</mat-label>
            <input
              matInput
              formControlName="capacity"
              required
            /> </mat-form-field
          ><br />

          <mat-form-field appearance="outline" class="w-50 mb-3">
            <mat-label>Classe</mat-label>
            <mat-select formControlName="classe" required>
              <mat-option>--</mat-option>
              <mat-option *ngFor="let classe of classes" [value]="classe.id">
                {{ classe.classname }}
              </mat-option>
            </mat-select> </mat-form-field
          ><br />
        </div>

        <div class="text-center mt-3">
          <button mat-raised-button class="m-2" matStepperPrevious>
            Retour
          </button>
          <button mat-raised-button color="primary" matStepperNext>
            Ajouter
          </button>
        </div>
      </form>
    </mat-step>
  </mat-stepper>
</div>
